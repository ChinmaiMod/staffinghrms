
# Copilot Instructions: Staffing HRMS

## 1. Big Picture Architecture
- Multi-tenant HRMS for staffing agencies, built with **React 18 + Vite** and **Supabase** (Postgres + RLS, Storage, Edge Functions).
- **Universal checklist system:** All document workflows (employee, project, timesheet, compliance) use a single, polymorphic architecture. Never create new document tables—extend the checklist system. See [UNIVERSAL_CHECKLIST_ARCHITECTURE.md](../UNIVERSAL_CHECKLIST_ARCHITECTURE.md).
- **Employee types:** Five types (`internal_india`, `internal_usa`, `it_usa`, `nonit_usa`, `healthcare_usa`) drive checklist templates and UI color coding.

## 2. Data Model & Patterns
- All tables prefixed `hrms_`, include `tenant_id UUID NOT NULL` (multi-tenancy) and often `business_id UUID`. RLS enforces tenant isolation via `auth.jwt() ->> 'tenant_id'`.
- Audit fields: `created_at`, `updated_at`, `created_by`, `updated_by`. Soft deletes: `deleted_at`/`is_active`.
- **Employee codes:** Format `<business_short_name><5-digit-seq>` (e.g., `IES00001`), auto-generated by `fn_generate_employee_code(business_id)`.
- See [HRMS_DATA_MODEL.md](../HRMS_DATA_MODEL.md) for schema and table relationships.

## 3. Universal Checklist System
- **Checklist types** (`hrms_checklist_types`) are admin-configurable and map to any table via `target_table_name` + `target_id_column`.
- **Documents** (`hrms_documents`) use polymorphic attachment: `entity_type` + `entity_id` (e.g., `employee`, `project`, `timesheet`, `compliance`, `custom`).
- **Checklist workflow:**
  1. Add checklist type (admin UI)
  2. Create template → groups → items
  3. Store uploads with correct `entity_type`, `entity_id`, `checklist_item_id`
- See [ADMIN_CONFIGURABLE_CHECKLIST_GUIDE.md](../ADMIN_CONFIGURABLE_CHECKLIST_GUIDE.md) for dynamic mapping and query patterns.

## 4. Domain-Specific Rules
- **Project rates:** Use `hrms_project_rate_history` for all rate changes (never overwrite). Enforced by exclusion constraint. See [PROJECT_RATE_CHANGE_MANAGEMENT.md](../PROJECT_RATE_CHANGE_MANAGEMENT.md).
- **LCA compliance:** Only one active LCA project per employee. Adding another triggers amendment alert.
- **Vendor chains:** Up to 10 levels via `hrms_project_vendors` (`vendor_level` 1-10). Master vendor data in `hrms_vendors`.
- **Clients:** CRM `clients` table is the single source of truth. HRMS references via `client_id`.

## 5. UI & Design System
- Design tokens, colors, and component standards in [UI_DESIGN_DOCS/00_DESIGN_SYSTEM.md](../UI_DESIGN_DOCS/00_DESIGN_SYSTEM.md).
- Employee type colors: Internal India `#8B5CF6`, Internal USA `#3B82F6`, IT USA `#10B981`, Non-IT USA `#F97316`, Healthcare USA `#EC4899`.
- **Client Management UI:** See [UI_DESIGN_DOCS/16_CLIENT_MANAGEMENT.md](../UI_DESIGN_DOCS/16_CLIENT_MANAGEMENT.md).

## 6. Integrations & External Services
- **CRM bridge:** `crm_hrms_contact_bridge` table + Edge Functions for contact→employee sync. See [STAFFING_CRM_TO_HRMS_BRIDGE_DOCUMENTATION.md](../STAFFING_CRM_TO_HRMS_BRIDGE_DOCUMENTATION.md).
- **External services:** AI parsing (OpenRouter/Claude), Email (Resend), Billing (Stripe), Hosting (Vercel).

## 7. Developer Workflow
- **Build:** `npm install` → `npm run dev`
- **Test:** `npm test` (unit), `npm run test:e2e` (end-to-end)
- **Supabase migrations:** In `supabase/migrations/`, sequentially numbered. Use for schema changes.
- **Environment variables:**
  - `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`, `VITE_OPENROUTER_API_KEY`, `VITE_FUNCTIONS_URL`
- **Frontend:** Main code in `src/components/HRMS/*`. Supabase functions in `supabase/functions/`.

## 8. Project-Specific Conventions
- **Never hardcode checklist types or document tables.** All types are admin-configurable and mapped via DB.
- **Polymorphic document storage:** Always use `entity_type`/`entity_id` for attachments.
- **Audit fields:** Always set `created_by`/`updated_by` from auth context (see CRM pattern).
- **RLS:** All tables must have tenant isolation policies.
- **Employee/project codes:** Always use auto-generation functions.

## 9. Key References
- Universal checklist: [UNIVERSAL_CHECKLIST_ARCHITECTURE.md](../UNIVERSAL_CHECKLIST_ARCHITECTURE.md)
- Data model: [HRMS_DATA_MODEL.md](../HRMS_DATA_MODEL.md)
- Checklist admin: [ADMIN_CONFIGURABLE_CHECKLIST_GUIDE.md](../ADMIN_CONFIGURABLE_CHECKLIST_GUIDE.md)
- Rate history: [PROJECT_RATE_CHANGE_MANAGEMENT.md](../PROJECT_RATE_CHANGE_MANAGEMENT.md)
- UI design: [UI_DESIGN_DOCS/00_DESIGN_SYSTEM.md](../UI_DESIGN_DOCS/00_DESIGN_SYSTEM.md)
- CRM bridge: [STAFFING_CRM_TO_HRMS_BRIDGE_DOCUMENTATION.md](../STAFFING_CRM_TO_HRMS_BRIDGE_DOCUMENTATION.md)

---

**For unclear or missing patterns, ask the user for clarification or examples.**
